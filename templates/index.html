<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹íˆ° ì™„ê²° ì•Œë¦¬ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', 'Noto Sans KR', sans-serif; background-color: #121212; color: #e0e0e0; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { color: #ffffff; background-color: #4f46e5; }
        .webtoon-row { border-bottom: 1px solid #2d2d2d; transition: background-color 0.2s ease; }
        .webtoon-row:hover { background-color: #1e1e1e; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2a2a2a; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <header class="bg-black/50 backdrop-blur-lg py-4 shadow-lg sticky top-0 z-30 border-b border-gray-800">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="#" id="homeButton" class="flex items-center gap-3 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <h1 class="text-xl md:text-2xl font-black text-white tracking-tighter">ì™„ê²° ì•Œë¦¬ë¯¸</h1>
            </a>
            <input type="text" id="searchInput" placeholder="ì „ì²´ ì›¹íˆ° ê²€ìƒ‰..." class="w-1/2 md:w-1/3 p-2 rounded-lg bg-[#2a2a2a] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white transition-all duration-300">
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div id="mainTabContainer" class="mb-4">
            <div class="flex space-x-4">
                <button data-content-type="webtoon" class="main-tab-button active">ì›¹íˆ°</button>
                <button data-content-type="novel" class="main-tab-button">ì›¹ì†Œì„¤</button>
            </div>
        </div>
        <div id="tabContainer" class="mb-6 overflow-x-auto"><div class="flex space-x-2 border-b border-gray-700"></div></div>
        <div id="webtoonListContainer"></div>
        <div id="paginationContainer" class="text-center py-8"></div>
        <div id="statusIndicator" class="text-center py-20"></div>
    </main>

    <section class="container mx-auto p-4 md:p-8 mt-12">
        <div class="bg-[#1e1e1e] p-8 rounded-lg border border-gray-800 text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">ì„œë¹„ìŠ¤ ê°œì„ ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”!</h2>
            <p class="text-gray-400 mb-8">ì—¬ëŸ¬ë¶„ì˜ ì†Œì¤‘í•œ ì˜ê²¬ì´ ë” ë‚˜ì€ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>
            <a href="https://forms.gle/HHhRRxZdE8g4x6nm9" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg transition-colors">ê°œì„  ì˜ê²¬ ë‚¨ê¸°ê¸°</a>
        </div>
    </section>

    <footer class="text-center py-8 mt-4 border-t border-gray-800"><p class="text-gray-500 text-sm">&copy; 2025 Webtoon Notifier. All rights reserved.</p></footer>

    <div id="subscribeModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div id="modalContent" class="relative z-10 modal-content p-8 rounded-xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-2 text-white">ì™„ê²° ì•Œë¦¼ ë°›ê¸°</h2>
            <p id="modalWebtoonTitle" class="mb-4 text-gray-400"></p>
            <div id="modalWebtoonLinkContainer" class="mb-6"></div>
            <div class="mb-4">
                <input type="email" id="emailInput" placeholder="ì•Œë¦¼ë°›ì„ ì´ë©”ì¼ ì£¼ì†Œ" class="w-full p-3 rounded-md bg-[#3a3a3c] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                <p id="emailError" class="text-red-400 text-sm mt-1 h-5"></p>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelButton" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">ì·¨ì†Œ</button>
                <button id="subscribeButton" class="px-6 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-semibold transition-colors">êµ¬ë…í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 px-6 py-3 rounded-lg shadow-xl text-white transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const UI = {
                tabContainer: document.getElementById('tabContainer').querySelector('.flex'),
                webtoonListContainer: document.getElementById('webtoonListContainer'),
                paginationContainer: document.getElementById('paginationContainer'),
                statusIndicator: document.getElementById('statusIndicator'),
                searchInput: document.getElementById('searchInput'),
                homeButton: document.getElementById('homeButton'),
                modal: document.getElementById('subscribeModal'),
                modalContent: document.getElementById('modalContent'),
                modalWebtoonTitle: document.getElementById('modalWebtoonTitle'),
                modalWebtoonLinkContainer: document.getElementById('modalWebtoonLinkContainer'),
                emailInput: document.getElementById('emailInput'),
                emailError: document.getElementById('emailError'),
                subscribeButton: document.getElementById('subscribeButton'),
                cancelButton: document.getElementById('cancelButton'),
                toast: document.getElementById('toast'),
            };

            const TABS = {
                webtoon: { mon: 'ì›”', tue: 'í™”', wed: 'ìˆ˜', thu: 'ëª©', fri: 'ê¸ˆ', sat: 'í† ', sun: 'ì¼', daily: 'ë§¤ì¼+', hiatus: 'íœ´ì¬', completed: 'ì™„ê²°' },
                novel: { latest: 'ìµœì‹ ìˆœ', popular: 'ì¸ê¸°ìˆœ', completed: 'ì™„ê²°' }
            };

            const state = {
                activeContentType: 'webtoon',
                activeTab: 'mon',
                currentTitleId: null,
                currentSource: null,
                searchTimeout: null,
                isSearching: false,
                searchResults: [],
                cache: {
                    ongoing: null,
                    hiatus: [],
                    completed: []
                },
                pagination: {
                    hiatus: { nextCursor: null, hasMore: true, isLoading: false },
                    completed: { nextCursor: null, hasMore: true, isLoading: false }
                }
            };

            function showStatus(message, isError = false) {
                UI.webtoonListContainer.innerHTML = '';
                UI.paginationContainer.innerHTML = '';
                if (message === 'loading') {
                    UI.statusIndicator.innerHTML = `<div class="loader"></div>`;
                } else {
                    UI.statusIndicator.innerHTML = `<p class="text-xl ${isError ? 'text-red-400' : 'text-gray-500'}">${message}</p>`;
                }
            }

            async function fetchDataForTab(tabKey) {
                const isPaginated = tabKey === 'hiatus' || tabKey === 'completed';
                if (isPaginated) {
                    if (state.pagination[tabKey].isLoading || !state.pagination[tabKey].hasMore) return;
                    state.pagination[tabKey].isLoading = true;
                }
                renderPagination();

                try {
                    let url;
                    const typeParam = `type=${state.activeContentType}`;

                    if (isPaginated) {
                        const cursor = state.pagination[tabKey].nextCursor;
                        url = cursor ? `/api/contents/${tabKey}?${typeParam}&last_title=${encodeURIComponent(cursor)}` : `/api/contents/${tabKey}?${typeParam}`;
                    } else {
                        url = `/api/contents/ongoing?${typeParam}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`);

                    const data = await response.json();

                    if (isPaginated) {
                        state.cache[tabKey].push(...data.contents);
                        state.pagination[tabKey].nextCursor = data.next_cursor;
                        state.pagination[tabKey].hasMore = !!data.next_cursor;
                    } else {
                        state.cache.ongoing = data;
                    }
                } catch (error) {
                    showStatus('ì›¹íˆ° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true);
                    console.error('Fetch error:', error);
                } finally {
                    if (isPaginated) {
                        state.pagination[tabKey].isLoading = false;
                    }
                    renderWebtoonList();
                    renderPagination();
                }
            }

            function renderTabs() {
                UI.tabContainer.innerHTML = '';
                const currentTabs = TABS[state.activeContentType] || {};

                if (state.activeContentType === 'webtoon') {
                    UI.tabContainer.parentElement.style.display = 'block';
                    Object.entries(currentTabs).forEach(([key, value]) => {
                        const button = document.createElement('button');
                        button.className = `tab-button px-4 py-2 text-sm font-bold rounded-t-lg whitespace-nowrap ${state.activeTab === key ? 'active' : 'text-gray-400 hover:bg-gray-800'}`;
                        button.textContent = value;
                        button.dataset.tab = key;
                        button.addEventListener('click', () => handleTabClick(key));
                        UI.tabContainer.appendChild(button);
                    });
                } else {
                    UI.tabContainer.parentElement.style.display = 'none';
                }
            }

            async function handleTabClick(tabKey) {
                state.activeTab = tabKey;
                state.isSearching = false; // íƒ­ í´ë¦­ ì‹œ ê²€ìƒ‰ ìƒíƒœ í•´ì œ
                UI.searchInput.value = '';
                renderTabs();

                const isPaginated = tabKey === 'hiatus' || tabKey === 'completed';
                const cacheKey = isPaginated ? tabKey : 'ongoing';

                if (!state.cache[cacheKey] || (isPaginated && state.cache[cacheKey].length === 0)) {
                    showStatus('loading');
                    await fetchDataForTab(tabKey);
                } else {
                    renderWebtoonList();
                    renderPagination();
                }
            }

            function getStatusBadge(status) {
                const colors = { 'ì™„ê²°': 'bg-green-600', 'íœ´ì¬': 'bg-gray-600', 'ì—°ì¬ì¤‘': 'bg-blue-600' };
                return `<span class="text-xs font-semibold text-white px-3 py-1 rounded-full ${colors[status] || ''}">${status}</span>`;
            }

            // [ìˆ˜ì •] webtoon ê°ì²´ì— statusê°€ í•­ìƒ í¬í•¨ë˜ë¯€ë¡œ, ì¸ìë¥¼ í•˜ë‚˜ë§Œ ë°›ë„ë¡ ìˆ˜ì •
            function createWebtoonRow(webtoon) {
                const row = document.createElement('div');
                row.className = 'webtoon-row flex items-center justify-between p-4 cursor-pointer';

                // === ğŸš¨ [ìŠ¤í‚¤ë§ˆ í‘œì¤€í™”] ===
                // 'authors' ë¦¬ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì½ì–´ì™€ ì‰¼í‘œ(,)ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
                const authorsText = (webtoon.meta.common && webtoon.meta.common.authors && webtoon.meta.common.authors.length > 0)
                                    ? webtoon.meta.common.authors.join(', ')
                                    : 'ì‘ê°€ ì •ë³´ ì—†ìŒ';
                // =========================

                row.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-white truncate">${webtoon.title}</p>

                        <p class="text-sm text-gray-400 truncate">${authorsText}</p>

                    </div>
                    <div class="flex items-center space-x-4 ml-4 flex-shrink-0">${getStatusBadge(webtoon.status)}</div>`;
                // ğŸš¨ [ìˆ˜ì •] openModalì— webtoon.sourceë¥¼ ì„¸ ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬
                row.addEventListener('click', () => openModal(webtoon.content_id, webtoon.title, webtoon.source));
                return row;
            }

            // [í•µì‹¬ ìˆ˜ì •] ê²€ìƒ‰ ìƒíƒœì™€ íƒ­ ìƒíƒœì— ë”°ë¼ ë Œë”ë§í•  ë°ì´í„°ë¥¼ ê²°ì •
            function renderWebtoonList() {
                UI.webtoonListContainer.innerHTML = '';
                UI.statusIndicator.innerHTML = '';

                let listToRender;

                if (state.isSearching) {
                    listToRender = state.searchResults;
                    UI.tabContainer.parentElement.style.display = 'none';
                    UI.paginationContainer.style.display = 'none';
                } else {
                    const isPaginated = state.activeTab === 'hiatus' || state.activeTab === 'completed';
                    if (isPaginated) {
                        listToRender = state.cache[state.activeTab];
                    } else {
                        listToRender = state.cache.ongoing?.[state.activeTab] || [];
                    }
                    renderTabs(); // Re-render tabs to ensure visibility is correct
                    UI.paginationContainer.style.display = 'block';
                }

                if (!listToRender || listToRender.length === 0) {
                    // ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œë§Œ 'ê²°ê³¼ ì—†ìŒ' ë©”ì‹œì§€ í‘œì‹œ
                    const isLoading = state.isSearching || (state.pagination[state.activeTab] && state.pagination[state.activeTab].isLoading);
                    if (!isLoading) {
                        const tabName = TABS[state.activeContentType]?.[state.activeTab] || state.activeTab;
                        showStatus(state.isSearching ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : `'${tabName}' ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
                    }
                    return;
                }

                listToRender.forEach(webtoon => UI.webtoonListContainer.appendChild(createWebtoonRow(webtoon)));
            }

            function renderPagination() {
                const tabKey = state.activeTab;
                if (state.isSearching || (tabKey !== 'hiatus' && tabKey !== 'completed')) {
                    UI.paginationContainer.innerHTML = '';
                    return;
                }

                const pageState = state.pagination[tabKey];
                if (pageState.isLoading) {
                    UI.paginationContainer.innerHTML = `<div class="loader"></div>`;
                } else if (pageState.hasMore) {
                    const loadMoreButton = document.createElement('button');
                    loadMoreButton.textContent = 'ë” ë³´ê¸°';
                    loadMoreButton.className = 'bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg transition-colors';
                    loadMoreButton.onclick = () => fetchDataForTab(tabKey);
                    UI.paginationContainer.innerHTML = '';
                    UI.paginationContainer.appendChild(loadMoreButton);
                } else if (state.cache[tabKey].length > 0) {
                     UI.paginationContainer.innerHTML = `<p class="text-gray-500">ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤.</p>`;
                } else {
                    UI.paginationContainer.innerHTML = '';
                }
            }

            // [ì‹ ê·œ] ì„œë²„ì— ê²€ìƒ‰ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
            async function performSearch() {
                const searchTerm = UI.searchInput.value.trim();

                if (!searchTerm) {
                    state.isSearching = false;
                    renderWebtoonList();
                    renderPagination();
                    return;
                }

                state.isSearching = true;
                showStatus('loading');

                try {
                    const response = await fetch(`/api/contents/search?q=${encodeURIComponent(searchTerm)}&type=${state.activeContentType}`);
                    if (!response.ok) throw new Error('Search API Error');
                    state.searchResults = await response.json();
                    renderWebtoonList();
                } catch (error) {
                    showStatus('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
                    console.error('Search error:', error);
                }
            }

            // ğŸš¨ [ìˆ˜ì •] source ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
            function openModal(contentId, titleText, source) {
                state.currentTitleId = contentId;
                state.currentSource = source; // ğŸš¨ [ì¶”ê°€] stateì— source ì €ì¥
                UI.modalWebtoonTitle.textContent = `'${titleText}'`;

                let webtoonLink = '#'; // ê¸°ë³¸ ë§í¬

                // ğŸš¨ [ì¶”ê°€] sourceì— ë”°ë¼ ë§í¬ ë¶„ê¸°
                if (source === 'naver_webtoon') {
                    webtoonLink = `https://comic.naver.com/webtoon/list?titleId=${contentId}`;
                } else if (source === 'kakaopage') { // ì¹´ì¹´ì˜¤ì›¹íˆ°ì˜ ì†ŒìŠ¤ ë¬¸ìì—´ (ì˜ˆ: 'kakaopage')
                    webtoonLink = `https://page.kakao.com/content/${contentId}`; // ì¹´ì¹´ì˜¤í˜ì´ì§€ì˜ URL í˜•ì‹ (ì˜ˆì‹œ)
                }
                // (ì¶”í›„ ë‹¤ë¥¸ í”Œë«í¼ ë§í¬ë„ ì´ê³³ì— ì¶”ê°€)

                UI.modalWebtoonLinkContainer.innerHTML = `<a href="${webtoonLink}" target="_blank" class="inline-flex items-center gap-2 text-indigo-400 hover:text-indigo-300 transition-colors"><span>ì›¹íˆ° ë°”ë¡œê°€ê¸°</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>`;
                UI.modal.classList.remove('hidden');
                setTimeout(() => UI.modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }

            function closeModal() {
                UI.modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    UI.modal.classList.add('hidden');
                    UI.emailError.textContent = '';
                    state.currentTitleId = null;
                }, 300);
            }

            async function handleSubscription() {
                const email = UI.emailInput.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(String(email).toLowerCase())) {
                    UI.emailError.textContent = 'ì´ë©”ì¼ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    UI.emailInput.focus();
                    return;
                }
                UI.emailError.textContent = '';
                try {
                    const response = await fetch('/api/subscriptions', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            contentId: state.currentTitleId,
                            source: state.currentSource // ğŸš¨ [ì¶”ê°€] source í•„ë“œ ì „ì†¡
                        }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'êµ¬ë… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    showToast('êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì™„ê²°ë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”.', 'success');
                    localStorage.setItem('userEmail', email);
                    closeModal();
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }

            function showToast(message, type = 'success') {
                UI.toast.textContent = message;
                UI.toast.className = `fixed bottom-10 right-10 px-6 py-3 rounded-lg shadow-xl text-white transform transition-all duration-500 ease-in-out ${type === 'success' ? 'bg-indigo-600' : 'bg-red-600'}`;
                UI.toast.classList.remove('opacity-0', 'translate-y-20');
                setTimeout(() => UI.toast.classList.add('opacity-0', 'translate-y-20'), 3000);
            }

            function initialize() {
                document.querySelectorAll('.main-tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        state.activeContentType = button.dataset.contentType;
                        document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        // ì½˜í…ì¸  íƒ€ì…ì— ë§ëŠ” ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì´ˆê¸°í™”
                        const currentTabs = TABS[state.activeContentType] || {};
                        state.activeTab = Object.keys(currentTabs)[0];

                        renderTabs();
                        handleTabClick(state.activeTab);
                    });
                });

                // [í•µì‹¬ ìˆ˜ì •] ê²€ìƒ‰ ì…ë ¥ ì‹œ ì„œë²„ì— ê²€ìƒ‰ ìš”ì²­ (ë””ë°”ìš´ì‹± ì ìš©)
                UI.searchInput.addEventListener('input', () => {
                    clearTimeout(state.searchTimeout);
                    state.searchTimeout = setTimeout(performSearch, 300); // 300ms ë””ë°”ìš´ìŠ¤
                });

                UI.homeButton.addEventListener('click', (e) => { e.preventDefault(); window.location.reload(); });
                UI.emailInput.value = localStorage.getItem('userEmail') || '';
                UI.emailInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSubscription(); });
                UI.cancelButton.addEventListener('click', closeModal);
                UI.subscribeButton.addEventListener('click', handleSubscription);
                UI.modal.addEventListener('click', (e) => { if (e.target === UI.modal) closeModal(); });

                renderTabs();
                handleTabClick(state.activeTab);
            }

            initialize();
        });
    </script>
</body>
</html>